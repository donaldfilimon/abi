# =============================================================================
# ABI Instance Custom Resource Definition
# =============================================================================
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: abiinstances.abi.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
  labels:
    app.kubernetes.io/name: abi-operator
    app.kubernetes.io/managed-by: abi-operator
spec:
  group: abi.io
  names:
    kind: AbiInstance
    listKind: AbiInstanceList
    plural: abiinstances
    singular: abiinstance
    shortNames:
      - abi
      - abis
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      subresources:
        status: {}
        scale:
          specReplicasPath: .spec.replicas
          statusReplicasPath: .status.readyReplicas
      additionalPrinterColumns:
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Ready
          type: integer
          jsonPath: .status.readyReplicas
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Version
          type: string
          jsonPath: .status.version
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          description: AbiInstance is the Schema for the abiinstances API
          properties:
            apiVersion:
              type: string
              description: >-
                APIVersion defines the versioned schema of this representation
                of an object.
            kind:
              type: string
              description: >-
                Kind is a string value representing the REST resource this
                object represents.
            metadata:
              type: object
            spec:
              type: object
              description: AbiInstanceSpec defines the desired state of AbiInstance
              required:
                - replicas
              properties:
                # Replica configuration
                replicas:
                  type: integer
                  minimum: 0
                  maximum: 100
                  default: 1
                  description: Number of ABI instance replicas

                # Image configuration
                image:
                  type: object
                  description: Container image configuration
                  properties:
                    repository:
                      type: string
                      default: "ghcr.io/abi/abi"
                      description: Container image repository
                    tag:
                      type: string
                      default: "latest"
                      description: Container image tag
                    pullPolicy:
                      type: string
                      enum: ["Always", "IfNotPresent", "Never"]
                      default: "IfNotPresent"
                      description: Image pull policy
                    pullSecrets:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                      description: Image pull secrets

                # Feature flags
                features:
                  type: object
                  description: ABI feature configuration
                  properties:
                    ai:
                      type: boolean
                      default: true
                      description: Enable AI/LLM features
                    gpu:
                      type: boolean
                      default: false
                      description: Enable GPU acceleration
                    database:
                      type: boolean
                      default: true
                      description: Enable vector database
                    network:
                      type: boolean
                      default: true
                      description: Enable distributed networking
                    web:
                      type: boolean
                      default: true
                      description: Enable web/HTTP features
                    profiling:
                      type: boolean
                      default: false
                      description: Enable performance profiling

                # GPU configuration
                gpu:
                  type: object
                  description: GPU configuration (requires features.gpu=true)
                  properties:
                    backend:
                      type: string
                      enum: ["auto", "cuda", "vulkan", "metal", "webgpu", "none"]
                      default: "auto"
                      description: GPU backend to use
                    count:
                      type: integer
                      minimum: 0
                      maximum: 8
                      default: 1
                      description: Number of GPUs per replica
                    memory:
                      type: string
                      pattern: "^[0-9]+(Gi|Mi)$"
                      description: GPU memory limit (e.g., "8Gi")

                # Resource configuration
                resources:
                  type: object
                  description: Container resource requirements
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "100m"
                        memory:
                          type: string
                          default: "256Mi"
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "1000m"
                        memory:
                          type: string
                          default: "1Gi"

                # Storage configuration
                storage:
                  type: object
                  description: Persistent storage configuration
                  properties:
                    enabled:
                      type: boolean
                      default: true
                      description: Enable persistent storage
                    size:
                      type: string
                      default: "10Gi"
                      description: Storage size
                    storageClassName:
                      type: string
                      description: Storage class name
                    accessModes:
                      type: array
                      items:
                        type: string
                        enum: ["ReadWriteOnce", "ReadOnlyMany", "ReadWriteMany"]
                      default: ["ReadWriteOnce"]

                # Network configuration
                networking:
                  type: object
                  description: Network configuration
                  properties:
                    httpPort:
                      type: integer
                      default: 8080
                      description: HTTP service port
                    metricsPort:
                      type: integer
                      default: 9090
                      description: Metrics port
                    grpcPort:
                      type: integer
                      default: 50051
                      description: gRPC service port
                    serviceType:
                      type: string
                      enum: ["ClusterIP", "NodePort", "LoadBalancer"]
                      default: "ClusterIP"
                      description: Kubernetes service type

                # Environment configuration
                config:
                  type: object
                  description: Application configuration
                  properties:
                    logLevel:
                      type: string
                      enum: ["debug", "info", "warn", "error"]
                      default: "info"
                      description: Log level
                    logFormat:
                      type: string
                      enum: ["json", "text"]
                      default: "json"
                      description: Log format
                    tracing:
                      type: boolean
                      default: false
                      description: Enable distributed tracing
                    jaegerEndpoint:
                      type: string
                      description: Jaeger collector endpoint

                # LLM/AI configuration
                llm:
                  type: object
                  description: LLM provider configuration
                  properties:
                    provider:
                      type: string
                      enum: ["ollama", "openai", "anthropic", "huggingface", "local"]
                      default: "ollama"
                      description: LLM provider
                    ollamaHost:
                      type: string
                      default: "http://ollama-service:11434"
                      description: Ollama service host
                    model:
                      type: string
                      default: "llama3"
                      description: Default model name

                # Secret references
                secrets:
                  type: object
                  description: Secret references for API keys
                  properties:
                    openaiApiKeySecret:
                      type: object
                      properties:
                        name:
                          type: string
                        key:
                          type: string
                          default: "api-key"
                    anthropicApiKeySecret:
                      type: object
                      properties:
                        name:
                          type: string
                        key:
                          type: string
                          default: "api-key"
                    huggingfaceTokenSecret:
                      type: object
                      properties:
                        name:
                          type: string
                        key:
                          type: string
                          default: "token"

                # High availability
                highAvailability:
                  type: object
                  description: High availability configuration
                  properties:
                    enabled:
                      type: boolean
                      default: false
                      description: Enable HA mode
                    podDisruptionBudget:
                      type: object
                      properties:
                        minAvailable:
                          type: integer
                          minimum: 0
                        maxUnavailable:
                          type: integer
                          minimum: 0
                    antiAffinity:
                      type: string
                      enum: ["soft", "hard"]
                      default: "soft"
                      description: Pod anti-affinity mode

                # Autoscaling
                autoscaling:
                  type: object
                  description: Horizontal pod autoscaling configuration
                  properties:
                    enabled:
                      type: boolean
                      default: false
                      description: Enable HPA
                    minReplicas:
                      type: integer
                      minimum: 1
                      default: 1
                    maxReplicas:
                      type: integer
                      minimum: 1
                      default: 10
                    targetCPUUtilization:
                      type: integer
                      minimum: 1
                      maximum: 100
                      default: 80
                    targetMemoryUtilization:
                      type: integer
                      minimum: 1
                      maximum: 100

            status:
              type: object
              description: AbiInstanceStatus defines the observed state of AbiInstance
              properties:
                # Phase
                phase:
                  type: string
                  enum: ["Pending", "Creating", "Running", "Updating", "Failed", "Terminating"]
                  description: Current phase of the ABI instance

                # Replica counts
                replicas:
                  type: integer
                  description: Total number of replicas
                readyReplicas:
                  type: integer
                  description: Number of ready replicas
                availableReplicas:
                  type: integer
                  description: Number of available replicas
                updatedReplicas:
                  type: integer
                  description: Number of updated replicas

                # Version info
                version:
                  type: string
                  description: Current ABI version running
                observedGeneration:
                  type: integer
                  format: int64
                  description: Most recent generation observed

                # Health status
                health:
                  type: object
                  description: Health status of the instance
                  properties:
                    status:
                      type: string
                      enum: ["Healthy", "Degraded", "Unhealthy", "Unknown"]
                    message:
                      type: string
                    lastChecked:
                      type: string
                      format: date-time

                # Feature status
                enabledFeatures:
                  type: array
                  items:
                    type: string
                  description: List of enabled features

                # Conditions
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        description: Type of condition
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                    required:
                      - type
                      - status
                  description: Current service state conditions

                # Endpoint info
                endpoints:
                  type: object
                  properties:
                    http:
                      type: string
                    grpc:
                      type: string
                    metrics:
                      type: string
                  description: Service endpoints

                # Last applied config hash
                configHash:
                  type: string
                  description: Hash of the last applied configuration
