# AWS SAM Template for ABI Cloud Functions
#
# Deploy with:
#   sam build && sam deploy --guided
#
# Or for production:
#   sam build && sam deploy --config-file samconfig.toml
#
# Prerequisites:
#   - AWS SAM CLI installed
#   - AWS credentials configured
#   - Zig toolchain for cross-compilation

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: ABI Framework Cloud Function Deployment

# Global configuration applied to all functions
Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: provided.al2023
    Architectures:
      - x86_64
    Tracing: Active
    Environment:
      Variables:
        LOG_LEVEL: info
        ABI_CLOUD_PROVIDER: aws_lambda

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment environment

  EnableTracing:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable X-Ray tracing

  MemorySize:
    Type: Number
    Default: 256
    MinValue: 128
    MaxValue: 10240
    Description: Function memory in MB

  Timeout:
    Type: Number
    Default: 30
    MinValue: 1
    MaxValue: 900
    Description: Function timeout in seconds

Resources:
  # Main HTTP API Gateway
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref Environment
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
          - X-Request-ID

  # Example HTTP function
  HttpFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: !Sub 'abi-http-${Environment}'
      Handler: bootstrap
      CodeUri: ./
      MemorySize: !Ref MemorySize
      Timeout: !Ref Timeout
      Events:
        ApiEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /{proxy+}
            Method: ANY
      Environment:
        Variables:
          FUNCTION_TYPE: http
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

  # Example event-driven function (SQS trigger)
  QueueFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: !Sub 'abi-queue-${Environment}'
      Handler: bootstrap
      CodeUri: ./
      MemorySize: !Ref MemorySize
      Timeout: !Ref Timeout
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt MessageQueue.Arn
            BatchSize: 10
      Environment:
        Variables:
          FUNCTION_TYPE: queue
      Policies:
        - AWSLambdaBasicExecutionRole
        - SQSPollerPolicy:
            QueueName: !GetAtt MessageQueue.QueueName

  # Example scheduled function (cron trigger)
  ScheduledFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: !Sub 'abi-scheduled-${Environment}'
      Handler: bootstrap
      CodeUri: ./
      MemorySize: !Ref MemorySize
      Timeout: !Ref Timeout
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Description: Run every 5 minutes
            Enabled: true
      Environment:
        Variables:
          FUNCTION_TYPE: scheduled

  # SQS Queue for queue-triggered function
  MessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'abi-messages-${Environment}'
      VisibilityTimeout: 60
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DeadLetterQueue.Arn
        maxReceiveCount: 3

  # Dead letter queue for failed messages
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'abi-dlq-${Environment}'
      MessageRetentionPeriod: 1209600

  # CloudWatch Log Groups
  HttpFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/abi-http-${Environment}'
      RetentionInDays: 14

  QueueFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/abi-queue-${Environment}'
      RetentionInDays: 14

  ScheduledFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/abi-scheduled-${Environment}'
      RetentionInDays: 14

Outputs:
  HttpApiUrl:
    Description: HTTP API endpoint URL
    Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/'

  HttpFunctionArn:
    Description: HTTP Function ARN
    Value: !GetAtt HttpFunction.Arn

  QueueFunctionArn:
    Description: Queue Function ARN
    Value: !GetAtt QueueFunction.Arn

  ScheduledFunctionArn:
    Description: Scheduled Function ARN
    Value: !GetAtt ScheduledFunction.Arn

  MessageQueueUrl:
    Description: SQS Queue URL
    Value: !Ref MessageQueue

  MessageQueueArn:
    Description: SQS Queue ARN
    Value: !GetAtt MessageQueue.Arn
