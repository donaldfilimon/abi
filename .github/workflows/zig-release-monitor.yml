name: Zig Release Monitor

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      newer-version: ${{ steps.check-version.outputs.newer }}
      current-version: ${{ steps.check-version.outputs.current }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Zig versions
        id: check-version
        run: |
          # Get current minimum version from build.zig.zon
          CURRENT=$(grep 'minimum_zig_version' build.zig.zon | sed 's/.*"\(.*\)".*/\1/')
          echo "Current minimum: $CURRENT"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          # Get latest stable Zig version
          LATEST=$(curl -s https://ziglang.org/download/ | grep -oP 'release-\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          echo "Latest stable: $LATEST"
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ]; then
            echo "newer=true" >> $GITHUB_OUTPUT
            echo "A newer Zig version is available: $LATEST (current minimum: $CURRENT)"
          else
            echo "newer=false" >> $GITHUB_OUTPUT
            echo "No newer version available"
          fi

      - name: Create issue if newer version available
        if: steps.check-version.outputs.newer == 'true'
        run: |
          ISSUE_TITLE="Zig Update Available: ${{ steps.check-version.outputs.latest }}"
          ISSUE_BODY=$(cat <<EOF
          A new Zig stable release is available.

          **Current minimum version:** ${{ steps.check-version.outputs.current }}
          **Latest stable version:** ${{ steps.check-version.outputs.latest }}

          Consider updating `minimum_zig_version` in `build.zig.zon` and testing with the new release.

          Steps to update:
          1. Update \`minimum_zig_version\` in \`build.zig.zon\`
          2. Update CI to use new version in \`.github/workflows/ci.yml\`
          3. Run full test suite: \`zig build test --summary all\`
          4. Run optimized build: \`zig build -Doptimize=ReleaseFast\`
          5. Update CHANGELOG.md with version update

          This issue was automatically created by the Zig Release Monitor workflow.
          EOF
          )
          echo "$ISSUE_BODY" > issue_body.txt

          gh issue create \
            --title "$ISSUE_TITLE" \
            --body-file issue_body.txt \
            --label "dependencies,zig-update" \
            || echo "Issue creation skipped (may already exist or no permissions)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing issue if newer version available
        if: steps.check-version.outputs.newer == 'true'
        run: |
          # Find existing open issue about this version
          gh issue list --label "zig-update" --state open --json number,title | \
            jq -r '.[] | "\(.number) \(.title)"' | \
            while read number title; do
              if echo "$title" | grep -q "${{ steps.check-version.outputs.latest }}"; then
                echo "Issue #$number already exists for this version"
                exit 0
              fi
            done
          # If we get here, no existing issue - create one (already done above)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
