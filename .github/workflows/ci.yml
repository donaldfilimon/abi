name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            script_ext: .sh
          - os: macos-latest
            script_ext: .sh
          - os: windows-latest
            script_ext: .bat

    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Zig version from .zigversion
        id: zig-version
        run: echo "version=$(cat .zigversion | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ steps.zig-version.outputs.version }}

      - name: Cache Zig global cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.zig-cache-global
            ${{ github.workspace }}/.zig-cache
          key: zig-cache-${{ matrix.os }}-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-${{ matrix.os }}-

      - name: Format check
        # Windows git may auto-convert LF to CRLF, which causes zig fmt to
        # report every file as misformatted. Run the canonical check on Linux
        # only (the lint job also covers this).
        if: runner.os == 'Linux'
        run: zig fmt --check .

      - name: Build
        run: zig build

      - name: Validate feature-flag combinations
        # Compiles the project under 16 different feature-flag permutations
        # to catch compilation errors in gated code paths early.
        run: zig build validate-flags

      - name: Run unit tests
        # NOTE: This step also exercises stub parity tests, which verify that
        # stub modules stay in sync with their real (mod.zig) counterparts.
        run: zig build test --summary all

      - name: Build with GPU backends (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          zig build -Dgpu-backend=vulkan
          zig build -Dgpu-backend=auto

      - name: Build with GPU backends (macOS Metal)
        if: runner.os == 'macOS'
        run: zig build -Dgpu-backend=metal

      - name: CLI smoke test
        run: zig build cli-tests

      - name: Build docs site
        run: zig build docs-site

      - name: Verify tracked files unchanged
        run: |
          git update-index -q --refresh
          git diff --exit-code
          git diff --cached --exit-code

      - name: Build C library and header
        run: |
          zig build lib -Denable-gpu=false -Dgpu-backend=none
          zig build c-header -Denable-gpu=false -Dgpu-backend=none

      - name: Verify C header installed
        run: |
          test -f zig-out/include/abi.h
        shell: bash

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
    steps:
      - uses: actions/checkout@v4

      - name: Read Zig version from .zigversion
        id: zig-version
        run: echo "version=$(cat .zigversion | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ steps.zig-version.outputs.version }}

      - name: Cache Zig global cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.zig-cache-global
            ${{ github.workspace }}/.zig-cache
          key: zig-cache-lint-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-lint-

      - name: Check Zig version consistency
        run: bash scripts/check_zig_version_consistency.sh

      - name: Lint check
        run: zig build lint
