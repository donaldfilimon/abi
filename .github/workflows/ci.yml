name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            script_ext: .sh
          - os: macos-latest
            script_ext: .sh
          - os: windows-latest
            script_ext: .bat

    runs-on: ${{ matrix.os }}
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Zig version from .zigversion
        id: zig-version
        run: echo "version=$(cat .zigversion | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          # Version is read from .zigversion to avoid drift between CI and the project
          version: ${{ steps.zig-version.outputs.version }}

      - name: Format check
        run: zig fmt --check .

      - name: Build
        run: zig build

      - name: Validate feature-flag combinations
        # Compiles the project under 10 different feature-flag permutations
        # to catch compilation errors in gated code paths early.
        run: zig build validate-flags

      - name: Run unit tests
        # NOTE: This step also exercises stub parity tests, which verify that
        # stub modules stay in sync with their real (mod.zig) counterparts.
        run: zig build test --summary all

      - name: Build with GPU backends (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          zig build -Dgpu-backend=vulkan
          zig build -Dgpu-backend=auto

      - name: Build with GPU backends (macOS Metal)
        if: runner.os == 'macOS'
        run: zig build -Dgpu-backend=metal

      - name: CLI smoke test
        run: zig build cli-tests

      - name: Feature flag builds
        run: |
          zig build -Denable-ai=true
          zig build -Denable-gpu=true
          zig build -Denable-database=true
          zig build docs-site

      - name: Build C library and header
        run: |
          zig build lib
          zig build c-header

      - name: Verify C header installed
        run: |
          test -f zig-out/include/abi.h
        shell: bash

  lint:
    runs-on: ubuntu-latest
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
    steps:
      - uses: actions/checkout@v4

      - name: Read Zig version from .zigversion
        id: zig-version
        run: echo "version=$(cat .zigversion | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          # Version is read from .zigversion to avoid drift between CI and the project
          version: ${{ steps.zig-version.outputs.version }}

      - name: Lint check
        run: zig build lint
