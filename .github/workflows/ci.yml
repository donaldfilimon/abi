name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Format Check
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: master
      - run: zig build lint

  test:
    name: Test Suite
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: master
      - name: Main tests
        run: zig build test --summary all
      - name: Feature tests
        run: zig build feature-tests --summary all

  quality-gates:
    name: Quality Gates
    runs-on: macos-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: master
      - name: Full check
        run: zig build full-check
      - name: Validate baselines
        run: zig build validate-baseline
      - name: Validate feature flags
        run: zig build validate-flags
      - name: CLI smoke tests
        run: zig build cli-tests

  examples:
    name: Examples
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: master
      - name: Build all examples
        run: zig build examples
