name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            script_ext: .sh
          - os: macos-latest
            script_ext: .sh
          - os: windows-latest
            script_ext: .bat

    runs-on: ${{ matrix.os }}
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Zig build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache-global
            zig-cache
            zig-out
          key: ${{ runner.os }}-zig-${{ hashFiles('build.zig', 'build.zig.zon', '.zigversion') }}
          restore-keys: |
            ${{ runner.os }}-zig-

      - name: Install Zig 0.16
        uses: goto-bus-stop/setup-zig@v2
        with:
          # Keep CI reproducible: match repo's declared Zig version (.zigversion / build.zig.zon)
          version: 0.16.0-dev.2368+380ea6fb5

      - name: Format check
        run: zig fmt --check .

      - name: Build
        run: zig build

      - name: Run unit tests
        run: zig build test --summary all

      - name: Build with GPU backends (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          zig build -Dgpu-backend=vulkan
          zig build -Dgpu-backend=auto

      - name: Build with GPU backends (macOS Metal)
        if: runner.os == 'macOS'
        run: zig build -Dgpu-backend=metal

      - name: CLI smoke test
        run: zig build cli-tests

      - name: Feature flag builds
        run: |
          zig build -Denable-ai=true
          zig build -Denable-gpu=true
          zig build -Denable-database=true
          zig build docs-site

      - name: Build C library and header
        run: |
          zig build lib
          zig build c-header

      - name: Verify C header installed
        run: |
          test -f zig-out/include/abi.h
        shell: bash

  lint:
    runs-on: ubuntu-latest
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
    steps:
      - uses: actions/checkout@v4

      - name: Cache Zig build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache-global
            zig-cache
            zig-out
          key: ${{ runner.os }}-zig-${{ hashFiles('build.zig', 'build.zig.zon', '.zigversion') }}
          restore-keys: |
            ${{ runner.os }}-zig-

      - name: Install Zig 0.16
        uses: goto-bus-stop/setup-zig@v2
        with:
          # Keep CI reproducible: match repo's declared Zig version (.zigversion / build.zig.zon)
          version: 0.16.0-dev.2368+380ea6fb5

      - name: Lint check
        run: zig build lint
