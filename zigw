#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="$(tr -d '\r\n' < "$ROOT_DIR/.zigversion")"

OS_NAME="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH_NAME="$(uname -m)"

case "$OS_NAME" in
  darwin) OS_TAG="macos" ;;
  linux) OS_TAG="linux" ;;
  *)
    echo "Unsupported OS: $OS_NAME" >&2
    exit 1
    ;;
esac

case "$ARCH_NAME" in
  arm64|aarch64) ARCH_TAG="aarch64" ;;
  x86_64|amd64) ARCH_TAG="x86_64" ;;
  *)
    echo "Unsupported architecture: $ARCH_NAME" >&2
    exit 1
    ;;
esac

TOOLCHAIN_DIR="$ROOT_DIR/.zig-dl/toolchain/zig-${ARCH_TAG}-${OS_TAG}-${VERSION}"
ZIG_BIN="$TOOLCHAIN_DIR/zig"

if [[ ! -x "$ZIG_BIN" ]]; then
  mkdir -p "$ROOT_DIR/.zig-dl" "$ROOT_DIR/.zig-dl/toolchain"
  ARCHIVE="$ROOT_DIR/.zig-dl/zig-${ARCH_TAG}-${OS_TAG}-${VERSION}.tar.xz"
  URL="https://ziglang.org/builds/zig-${ARCH_TAG}-${OS_TAG}-${VERSION}.tar.xz"

  echo "Fetching pinned Zig toolchain: $URL" >&2
  curl -fL "$URL" -o "$ARCHIVE"
  tar -xf "$ARCHIVE" -C "$ROOT_DIR/.zig-dl/toolchain"
fi

exec "$ZIG_BIN" "$@"
